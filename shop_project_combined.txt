

### shop/models.py ###

from django.db import models
from django.utils.text import slugify
from django.contrib.auth.models import User

# ============================
# CATEGORY
# ============================
class Category(models.Model):
    name = models.CharField(max_length=100, unique=True)
    slug = models.SlugField(unique=True, blank=True)
    description = models.TextField(blank=True)

    class Meta:
        ordering = ['name']
        verbose_name_plural = 'Categories'

    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)

    def __str__(self):
        return self.name


# ============================
# PRODUCT
# ============================
class Product(models.Model):
    title = models.CharField(max_length=255)
    slug = models.SlugField(unique=True, blank=True)
    category = models.ForeignKey(Category, on_delete=models.CASCADE, related_name='products')
    description = models.TextField(blank=True)
    price = models.DecimalField(max_digits=9, decimal_places=2)
    stock = models.PositiveIntegerField(default=10)
    featured = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.title)
        super().save(*args, **kwargs)

    def __str__(self):
        return self.title


# ============================
# PRODUCT IMAGE
# ============================
class ProductImage(models.Model):
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name='images')
    image = models.ImageField(upload_to='products/')
    position = models.PositiveIntegerField(default=0)

    class Meta:
        ordering = ['position']  

    def __str__(self):
        return f"{self.product.title} image"


# ============================
# PRODUCT VARIANT
# ============================
class ProductVariant(models.Model):
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name='variants')
    name = models.CharField(max_length=100)  # "Small", "A3 print", "Framed", etc.
    stock = models.PositiveIntegerField(default=0)
    price_adjust = models.DecimalField(max_digits=9, decimal_places=2, default=0.00)

    class Meta:
        unique_together = ('product', 'name')
        ordering = ['name']

    def __str__(self):
        return f"{self.product.title} - {self.name}"

    @property
    def final_price(self):
        return self.product.price + self.price_adjust


# ============================
# CART
# ============================
class Cart(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)


class CartItem(models.Model):
    cart = models.ForeignKey(Cart, related_name='items', on_delete=models.CASCADE)
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.PositiveIntegerField(default=1)

    @property
    def total_price(self):
        return self.product.price * self.quantity


# ============================
# ORDER
# ============================

# ============================
# ORDER
# ============================
class Order(models.Model):
    user = models.ForeignKey('auth.User', on_delete=models.CASCADE)
    email = models.EmailField(blank=True, null=True)

    total_price = models.DecimalField(max_digits=10, decimal_places=2)

    stripe_session_id = models.CharField(max_length=255, blank=True, null=True)
    stripe_payment_intent = models.CharField(max_length=255, blank=True, null=True)

    STATUS_CHOICES = [
        ("paid", "Paid"),
        ("shipped", "Shipped"),
        ("delivered", "Delivered"),
        ("cancelled", "Cancelled"),
    ]
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="paid")

    # shipping info collected from Stripe Checkout
    shipping_name = models.CharField(max_length=255, blank=True, null=True)
    shipping_address1 = models.CharField(max_length=255, blank=True, null=True)
    shipping_address2 = models.CharField(max_length=255, blank=True, null=True)
    shipping_city = models.CharField(max_length=255, blank=True, null=True)
    shipping_postcode = models.CharField(max_length=50, blank=True, null=True)
    shipping_country = models.CharField(max_length=2, blank=True, null=True)

    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"Order #{self.id}"



class OrderItem(models.Model):
    order = models.ForeignKey(Order, related_name='items', on_delete=models.CASCADE)
    product = models.ForeignKey('shop.Product', on_delete=models.CASCADE)
    quantity = models.PositiveIntegerField()
    
    def __str__(self):
        return f"{self.quantity} x {self.product.title}"


==================================================


### shop/__init__.py ###


==================================================


### shop/apps.py ###

from django.apps import AppConfig


class ShopConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'shop'

==================================================


### shop/forms.py ###

from django import forms
from .models import Product, ProductImage, Category, ProductVariant

# ============================
# PRODUCT FORM
# ============================
class ProductForm(forms.ModelForm):
    class Meta:
        model = Product
        fields = [
            'title',
            'category',
            'description',
            'price',
            'stock',
            'featured'
        ]


# ============================
# SINGLE IMAGE FORM
# ============================
class ProductImageForm(forms.ModelForm):
    class Meta:
        model = ProductImage
        fields = ['image']


# ============================
# MULTI-IMAGE UPLOADER
# ============================
class MultipleFileInput(forms.ClearableFileInput):
    allow_multiple_selected = True


class MultiImageUploadForm(forms.Form):
    images = forms.FileField(
        widget=MultipleFileInput(attrs={'multiple': True}),
        required=False
    )

    def clean_images(self):
        # ALWAYS return a list of uploaded files.
        # This bypasses Django's single-file validation.
        return self.files.getlist('images')


# ============================
# CATEGORY FORM
# ============================
class CategoryForm(forms.ModelForm):
    class Meta:
        model = Category
        fields = ['name', 'description']


# ============================
# VARIANT FORM
# ============================
class VariantForm(forms.ModelForm):
    class Meta:
        model = ProductVariant
        fields = ['name', 'stock', 'price_adjust']


# ============================
# CHECKOUT FORM
# ============================
class CheckoutForm(forms.Form):
    name = forms.CharField(max_length=100)
    address = forms.CharField(widget=forms.Textarea)
    payment_method = forms.ChoiceField(choices=[('card', 'Credit Card'), ('paypal', 'PayPal')])

    def clean(self):
        # You can add any custom validation logic for the checkout form here
        cleaned_data = super().clean()
        # Example of custom validation:
        # if not cleaned_data.get("payment_method"):
        #     raise forms.ValidationError("Please select a payment method.")
        return cleaned_data

==================================================


### shop/admin.py ###

from django.contrib import admin
from .models import Product, Category, ProductImage, ProductVariant


@admin.register(Product)
class ProductAdmin(admin.ModelAdmin):
    list_display = ('title', 'category', 'price', 'stock', 'featured')
    prepopulated_fields = {'slug': ('title',)}
    search_fields = ('title', 'description')
    list_filter = ('category', 'featured')


@admin.register(Category)
class CategoryAdmin(admin.ModelAdmin):
    list_display = ('name', 'slug')
    prepopulated_fields = {'slug': ('name',)}


@admin.register(ProductImage)
class ProductImageAdmin(admin.ModelAdmin):
    list_display = ('product', 'image')


@admin.register(ProductVariant)
class ProductVariantAdmin(admin.ModelAdmin):
    list_display = ('product', 'name', 'stock', 'price_adjust')

==================================================


### shop/tests.py ###

from django.test import TestCase

# Create your tests here.

==================================================


### shop/urls.py ###

from django.urls import path
from . import views

app_name = "shop"

urlpatterns = [

    # ============================
    # MANAGEMENT PANEL (ADMIN SIDE)
    # ============================
    path('manage/products/', views.manage_products, name='manage_products'),
    path('manage/products/add/', views.add_product, name='add_product'),
    path('manage/products/<int:pk>/edit/', views.edit_product, name='edit_product'),
    path('manage/products/<int:pk>/delete/', views.delete_product, name='delete_product'),
    path('manage/products/bulk-delete/', views.bulk_delete, name='bulk_delete'),
    path('manage/products/<int:pk>/duplicate/', views.duplicate_product, name='duplicate_product'),
        # Orders (admin)
    path('manage/orders/', views.manage_orders, name='manage_orders'),
    path('manage/orders/<int:order_id>/', views.order_detail, name='order_detail'),



    # Image uploads + ordering
    path('manage/products/<int:product_id>/images/upload/', views.upload_product_image, name='upload_product_image'),
    path('manage/images/<int:image_id>/delete/', views.delete_product_image, name='delete_product_image'),
    path('manage/images/reorder/', views.update_image_order, name='update_image_order'),

    # Categories
    path('manage/categories/', views.manage_categories, name='manage_categories'),
    path('manage/categories/add/', views.add_category, name='add_category'),
    path('manage/categories/<int:pk>/edit/', views.edit_category, name='edit_category'),
    path('manage/categories/<int:pk>/delete/', views.delete_category, name='delete_category'),

    # Variants
    path('manage/variants/add/<int:product_id>/', views.add_variant, name='add_variant'),
    path('manage/variants/<int:variant_id>/edit/', views.edit_variant, name='edit_variant'),
    path('manage/variants/<int:variant_id>/delete/', views.delete_variant, name='delete_variant'),


# ============================
# PUBLIC SHOP FRONT
# ============================

path('webhooks/stripe/', views.stripe_webhook, name='stripe_webhook'),


# Shop index / product list
path('', views.product_list, name='shop_index'),

# Add to cart
path('add-to-cart/<int:product_id>/', views.add_to_cart, name='add_to_cart'),

# Cart + Checkout
path('cart/', views.cart_view, name='cart'),
path('remove-from-cart/<int:item_id>/', views.remove_from_cart, name='remove_from_cart'),
path('update-cart-item/<int:item_id>/', views.update_cart_item, name='update_cart_item'),
path('create-checkout-session/', views.create_checkout_session, name='create_checkout_session'),
path('thank-you/', views.success, name='success'),
path('cancel/', views.cancel, name='cancel'),
path("webhook/stripe/", views.stripe_webhook, name="stripe_webhook"),


# Product detail (slug LAST so it doesnâ€™t swallow other routes)
path('<slug:slug>/', views.product_detail, name='product_detail'),

]
==================================================


### shop/views.py ###

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.http import JsonResponse, HttpResponse
from django.urls import reverse
from django.views.decorators.csrf import csrf_exempt
from django.contrib.auth import get_user_model
import stripe

from config import settings
from shop.forms import CategoryForm, ProductForm, VariantForm

from .models import (
    Product,
    ProductImage,
    Category,
    ProductVariant,
    Cart,
    CartItem,
    Order,
    OrderItem,
)


# ===========================================================
# PUBLIC SHOP VIEWS
# ===========================================================

def product_list(request):
    products = Product.objects.all().order_by('-created_at')
    return render(request, "shop/product_list.html", {
        "products": products,
    })


def product_detail(request, slug):
    product = get_object_or_404(Product, slug=slug)
    images = product.images.all()
    variants = product.variants.all()

    return render(request, "shop/product_detail.html", {
        "product": product,
        "images": images,
        "variants": variants,
    })


@login_required
def add_to_cart(request, product_id):
    product = get_object_or_404(Product, id=product_id)

    variant_id = request.POST.get("variant_id")
    variant = None
    if variant_id:
        variant = ProductVariant.objects.filter(id=variant_id).first()

    cart, created = Cart.objects.get_or_create(user=request.user)

    existing_item = CartItem.objects.filter(
        cart=cart,
        product=product
    ).first()

    if existing_item:
        existing_item.quantity += 1
        existing_item.save()
        messages.success(request, f"Updated {product.title} quantity.")
    else:
        CartItem.objects.create(
            cart=cart,
            product=product,
            quantity=1
        )
        messages.success(request, f"{product.title} added to cart.")

    return redirect("shop:cart")


def success(request):
    return render(request, "shop/success.html")


def cancel(request):
    return render(request, "shop/cancel.html")


# ===========================================================
# CART SYSTEM (PUBLIC)
# ===========================================================

@login_required
def cart_view(request):
    cart, created = Cart.objects.get_or_create(user=request.user)
    items = cart.items.all()
    total = sum(item.total_price for item in items)

    return render(request, "shop/cart.html", {
        "cart": cart,
        "items": items,
        "total": total,
    })


@login_required
def remove_from_cart(request, item_id):
    item = get_object_or_404(CartItem, id=item_id, cart__user=request.user)
    item.delete()
    messages.success(request, "Item removed from cart.")
    return redirect("shop:cart")


@login_required
def update_cart_item(request, item_id):
    item = get_object_or_404(CartItem, id=item_id, cart__user=request.user)

    if request.method == "POST":
        new_quantity = request.POST.get("quantity")
        try:
            new_quantity = int(new_quantity)
            if new_quantity > 0:
                item.quantity = new_quantity
                item.save()
                messages.success(request, "Cart updated.")
            else:
                item.delete()
                messages.info(request, "Item removed from cart.")
        except ValueError:
            messages.error(request, "Invalid quantity.")

    return redirect("shop:cart")


# ===========================================================
# STRIPE CHECKOUT SESSION
# ===========================================================

@login_required
def create_checkout_session(request):
    print("ðŸ”¥ VIEW HIT:", request.method, request.POST)

    if request.method != "POST":
        return redirect("shop:cart")

    stripe.api_key = settings.STRIPE_SECRET_KEY

    cart, created = Cart.objects.get_or_create(user=request.user)
    items = cart.items.all()

    if not items:
        messages.error(request, "Your cart is empty.")
        return redirect("shop:cart")

    line_items = []
    for item in items:
        line_items.append({
            "price_data": {
                "currency": "gbp",
                "product_data": {
                    "name": item.product.title,
                },
                "unit_amount": int(item.product.price * 100),
            },
            "quantity": item.quantity,
        })

    try:
        session = stripe.checkout.Session.create(
            payment_method_types=["card"],
            mode="payment",
            line_items=line_items,
            customer_email=request.user.email,
            billing_address_collection="required",
            shipping_address_collection={
                "allowed_countries": ["GB"],
            },
            metadata={
                "user_id": request.user.id,
            },
            success_url=request.build_absolute_uri(reverse("shop:success")),
            cancel_url=request.build_absolute_uri(reverse("shop:cancel")),
        )

        return redirect(session.url)

    except Exception as e:
        messages.error(request, f"Stripe error: {e}")
        return redirect("shop:cart")


# ===========================================================
# MANAGEMENT (ADMIN AREA)
# ===========================================================

@login_required
def manage_products(request):
    products = Product.objects.all().order_by('-created_at')
    return render(request, "shop/manage/products_list.html", {
        "products": products
    })


@login_required
def add_product(request):
    if request.method == "POST":
        form = ProductForm(request.POST)
        if form.is_valid():
            product = form.save()
            messages.success(request, "Product created.")
            return redirect("shop:edit_product", pk=product.pk)
    else:
        form = ProductForm()

    return render(request, "shop/manage/product_form.html", {
        "form": form
    })


@login_required
def edit_product(request, pk):
    product = get_object_or_404(Product, pk=pk)

    if request.method == "POST":
        form = ProductForm(request.POST, instance=product)
        if form.is_valid():
            form.save()
            messages.success(request, "Product updated.")
        return redirect("shop:edit_product", pk=pk)

    form = ProductForm(instance=product)
    images = product.images.all()
    variants = product.variants.all()

    return render(request, "shop/manage/product_form.html", {
        "product": product,
        "form": form,
        "images": images,
        "variants": variants,
    })


@login_required
def delete_product(request, pk):
    product = get_object_or_404(Product, pk=pk)
    product.delete()
    messages.success(request, "Product deleted.")
    return redirect("shop:manage_products")


@login_required
def bulk_delete(request):
    ids = request.POST.getlist("ids")
    Product.objects.filter(id__in=ids).delete()
    messages.success(request, "Products deleted.")
    return redirect("shop:manage_products")


@login_required
def duplicate_product(request, pk):
    product = get_object_or_404(Product, pk=pk)
    product.pk = None
    product.slug = product.slug + "-copy"
    product.save()
    messages.success(request, "Product duplicated.")
    return redirect("shop:edit_product", pk=product.pk)


# ===========================================================
# IMAGE MANAGEMENT
# ===========================================================

@login_required
def upload_product_image(request, product_id):
    product = get_object_or_404(Product, pk=product_id)

    if request.method == "POST" and request.FILES.getlist("images"):
        for img in request.FILES.getlist("images"):
            ProductImage.objects.create(product=product, image=img)
        messages.success(request, "Images uploaded.")
    return redirect("shop:edit_product", pk=product_id)


@login_required
def delete_product_image(request, image_id):
    image = get_object_or_404(ProductImage, pk=image_id)
    product_id = image.product.id
    image.delete()
    messages.success(request, "Image deleted.")
    return redirect("shop:edit_product", pk=product_id)


@login_required
def update_image_order(request):
    if request.method == "POST":
        order = request.POST.getlist("order[]")
        for idx, image_id in enumerate(order):
            ProductImage.objects.filter(id=image_id).update(position=idx)
        return JsonResponse({"status": "success"})


# ===========================================================
# CATEGORY MANAGEMENT
# ===========================================================

@login_required
def manage_categories(request):
    categories = Category.objects.all()
    return render(request, "shop/manage/categories_list.html", {
        "categories": categories
    })


@login_required
def add_category(request):
    if request.method == "POST":
        form = CategoryForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Category added.")
            return redirect("shop:manage_categories")
    else:
        form = CategoryForm()

    return render(request, "shop/manage/category_form.html", {
        "form": form
    })


@login_required
def edit_category(request, pk):
    category = get_object_or_404(Category, pk=pk)

    if request.method == "POST":
        form = CategoryForm(request.POST, instance=category)
        if form.is_valid():
            form.save()
            messages.success(request, "Category updated.")
            return redirect("shop:manage_categories")
    else:
        form = CategoryForm(instance=category)

    return render(request, "shop/manage/category_form.html", {
        "form": form,
        "category": category
    })


@login_required
def delete_category(request, pk):
    category = get_object_or_404(Category, pk=pk)
    category.delete()
    messages.success(request, "Category deleted.")
    return redirect("shop:manage_categories")


# ===========================================================
# VARIANT MANAGEMENT
# ===========================================================

@login_required
def add_variant(request, product_id):
    product = get_object_or_404(Product, pk=product_id)

    if request.method == "POST":
        form = VariantForm(request.POST)
        if form.is_valid():
            variant = form.save(commit=False)
            variant.product = product
            variant.save()
            messages.success(request, "Variant added.")
            return redirect("shop:edit_product", pk=product_id)
    else:
        form = VariantForm()

    return render(request, "shop/manage/add_variant.html", {
        "form": form,
        "product": product,
    })


@login_required
def edit_variant(request, variant_id):
    variant = get_object_or_404(ProductVariant, pk=variant_id)
    product = variant.product

    if request.method == "POST":
        form = VariantForm(request.POST, instance=variant)
        if form.is_valid():
            form.save()
            messages.success(request, "Variant updated.")
            return redirect("shop:edit_product", pk=product.id)
    else:
        form = VariantForm(instance=variant)

    return render(request, "shop/manage/edit_variant.html", {
        "form": form,
        "variant": variant,
        "product": product,
    })


@login_required
def delete_variant(request, variant_id):
    variant = get_object_or_404(ProductVariant, pk=variant_id)
    product_id = variant.product.id
    variant.delete()
    messages.success(request, "Variant deleted.")
    return redirect("shop:edit_product", pk=product_id)


# ===========================================================
# STRIPE WEBHOOK â€“ FIXED + CLEANED
# ===========================================================

@csrf_exempt
def stripe_webhook(request):
    stripe.api_key = settings.STRIPE_SECRET_KEY
    endpoint_secret = getattr(settings, "STRIPE_WEBHOOK_SECRET", None)

    payload = request.body
    sig_header = request.META.get("HTTP_STRIPE_SIGNATURE")

    if not endpoint_secret:
        return HttpResponse(status=200)

    try:
        event = stripe.Webhook.construct_event(
            payload=payload,
            sig_header=sig_header,
            secret=endpoint_secret,
        )
    except (ValueError, stripe.error.SignatureVerificationError):
        return HttpResponse(status=400)

    if event["type"] == "checkout.session.completed":
        session = event["data"]["object"]

        # User from metadata
        User = get_user_model()
        user = None
        user_id = session.get("metadata", {}).get("user_id")
        if user_id:
            try:
                user = User.objects.get(id=user_id)
            except User.DoesNotExist:
                pass

        if not user:
            return HttpResponse(status=200)

        # Pricing + customer info
        total_price = (session.get("amount_total") or 0) / 100
        customer_details = session.get("customer_details") or {}
        shipping_details = session.get("shipping_details") or {}
        address = shipping_details.get("address") or {}

        # Create order
        order = Order.objects.create(
            user=user,
            email=customer_details.get("email"),
            total_price=total_price,
            stripe_session_id=session.get("id"),
            stripe_payment_intent=session.get("payment_intent"),

            shipping_name=shipping_details.get("name") or customer_details.get("name"),
            shipping_address1=address.get("line1"),
            shipping_address2=address.get("line2"),
            shipping_city=address.get("city"),
            shipping_postcode=address.get("postal_code"),
            shipping_country=address.get("country"),
        )

        # Stripe line items
        line_items = stripe.checkout.Session.list_line_items(session["id"])

        for li in line_items["data"]:
            product = Product.objects.filter(title=li.get("description")).first()
            if product:
                OrderItem.objects.create(
                    order=order,
                    product=product,
                    quantity=li.get("quantity", 1),
                )

        # Clear cart
        Cart.objects.filter(user=user).delete()

    return HttpResponse(status=200)


# ===========================================================
# ORDER MANAGEMENT
# ===========================================================

@login_required
def manage_orders(request):
    orders = Order.objects.all().order_by("-created_at")
    return render(request, "shop/manage/orders_list.html", {
        "orders": orders
    })


@login_required
def order_detail(request, order_id):
    order = get_object_or_404(Order, pk=order_id)

    if request.method == "POST":
        new_status = request.POST.get("status")
        if new_status in dict(Order.STATUS_CHOICES):
            order.status = new_status
            order.save()
            messages.success(request, "Order status updated.")
            return redirect("shop:order_detail", order_id=order.id)

    return render(request, "shop/manage/order_detail.html", {
        "order": order,
    })

==================================================


### shop/migrations/0004_cart_order_orderitem_cartitem.py ###

# Generated by Django 4.2.26 on 2025-11-30 16:52

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('shop', '0003_alter_productimage_options'),
    ]

    operations = [
        migrations.CreateModel(
            name='Cart',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='Order',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('total_price', models.DecimalField(decimal_places=2, max_digits=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='OrderItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('quantity', models.PositiveIntegerField()),
                ('order', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='items', to='shop.order')),
                ('product', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='shop.product')),
            ],
        ),
        migrations.CreateModel(
            name='CartItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('quantity', models.PositiveIntegerField(default=1)),
                ('cart', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='items', to='shop.cart')),
                ('product', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='shop.product')),
            ],
        ),
    ]

==================================================


### shop/migrations/0003_alter_productimage_options.py ###

# Generated by Django 4.2.26 on 2025-11-30 12:44

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('shop', '0002_productimage_position'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='productimage',
            options={'ordering': ['position']},
        ),
    ]

==================================================


### shop/migrations/__init__.py ###


==================================================


### shop/migrations/0002_productimage_position.py ###

# Generated by Django 4.2.26 on 2025-11-30 12:25

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('shop', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='productimage',
            name='position',
            field=models.PositiveIntegerField(default=0),
        ),
    ]

==================================================


### shop/migrations/0001_initial.py ###

# Generated by Django 4.2.26 on 2025-11-30 11:37

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Category',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True)),
                ('slug', models.SlugField(blank=True, unique=True)),
                ('description', models.TextField(blank=True)),
            ],
            options={
                'verbose_name_plural': 'Categories',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='Product',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=255)),
                ('slug', models.SlugField(blank=True, unique=True)),
                ('description', models.TextField(blank=True)),
                ('price', models.DecimalField(decimal_places=2, max_digits=9)),
                ('stock', models.PositiveIntegerField(default=10)),
                ('featured', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('category', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='products', to='shop.category')),
            ],
        ),
        migrations.CreateModel(
            name='ProductImage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('image', models.ImageField(upload_to='products/')),
                ('product', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='images', to='shop.product')),
            ],
        ),
        migrations.CreateModel(
            name='ProductVariant',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('stock', models.PositiveIntegerField(default=0)),
                ('price_adjust', models.DecimalField(decimal_places=2, default=0.0, max_digits=9)),
                ('product', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='variants', to='shop.product')),
            ],
            options={
                'ordering': ['name'],
                'unique_together': {('product', 'name')},
            },
        ),
    ]

==================================================


### shop/migrations/0005_order_email_order_shipping_address1_and_more.py ###

# Generated by Django 4.2.26 on 2025-12-04 20:21

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('shop', '0004_cart_order_orderitem_cartitem'),
    ]

    operations = [
        migrations.AddField(
            model_name='order',
            name='email',
            field=models.EmailField(blank=True, max_length=254, null=True),
        ),
        migrations.AddField(
            model_name='order',
            name='shipping_address1',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='order',
            name='shipping_address2',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='order',
            name='shipping_city',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='order',
            name='shipping_country',
            field=models.CharField(blank=True, max_length=2, null=True),
        ),
        migrations.AddField(
            model_name='order',
            name='shipping_name',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='order',
            name='shipping_postcode',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AddField(
            model_name='order',
            name='status',
            field=models.CharField(choices=[('paid', 'Paid'), ('shipped', 'Shipped'), ('delivered', 'Delivered'), ('cancelled', 'Cancelled')], default='paid', max_length=20),
        ),
        migrations.AddField(
            model_name='order',
            name='stripe_payment_intent',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='order',
            name='stripe_session_id',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
    ]

==================================================


### shop/templates/shop/cancel.html ###

<!-- shop/templates/shop/cancel.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Canceled</title>
</head>
<body>
    <h1>Payment Canceled</h1>
    <p>Your payment has been canceled. If you have any issues, please contact support.</p>
    <a href="/shop/">Back to Shop</a>
</body>
</html>

==================================================


### shop/templates/shop/product_detail.html ###

{% extends "base.html" %}
{% load static %}

{% block content %}


<div class="product-container">

    <div class="row g-5">

        <!-- LEFT SIDE â€” ARTWORK IMAGES -->
        <div class="col-md-7">

            <div class="image-wrapper">
                {% if images %}
                    <img id="main-img"
                         src="{{ images.0.image.url }}"
                         class="main-image shadow-sm">
                {% else %}
                    <img src="{% static 'img/placeholder.png' %}"
                         class="main-image shadow-sm">
                {% endif %}
            </div>

            {% if images|length > 1 %}
                <div class="thumbnail-row">
                    {% for img in images %}
                        <img src="{{ img.image.url }}"
                             onclick="document.getElementById('main-img').src='{{ img.image.url }}'">
                    {% endfor %}
                </div>
            {% endif %}
        </div>


        <!-- RIGHT SIDE â€” BUY BOX -->
        <div class="col-md-5">

            <div class="buy-box shadow-sm">

                <h1 class="product-title">{{ product.title }}</h1>

                 <p class="product-description">{{ product.description|linebreaks }}</p>

                {% if variants %}
                    <label class="fw-semibold">Select Option</label>
                    <select class="form-select variant-select" id="variantSelect">
                        {% for v in variants %}
                            <option value="{{ v.id }}">{{ v.name }} â€” Â£{{ v.final_price }}</option>
                        {% endfor %}
                    </select>
                {% endif %}

                   {% if variants %}
                        <input type="hidden" name="variant_id" id="variantInput">
                    {% endif %}

                <div class="product-price">Â£{{ product.price }}</div>

                <form method="POST" action="{% url 'shop:add_to_cart' product.id %}">
                    {% csrf_token %}

                    <button class="btn btn-dark buy-btn">
                        Add to Cart
                    </button>
                </form>

               

            </div>

        </div>

    </div>

</div>


<script>
    // Keep variant dropdown synced to hidden input
    const select = document.getElementById("variantSelect");
    const hiddenInput = document.getElementById("variantInput");

    if (select && hiddenInput) {
        hiddenInput.value = select.value;
        select.addEventListener("change", () => {
            hiddenInput.value = select.value;
        });
    }
</script>

{% endblock %}

==================================================


### shop/templates/shop/success.html ###

{% extends 'base.html' %}

{% block content %}
  <div class="thank-you">
    <h1>Thank you for your order!</h1>
    
    <h2>Payment Successful</h2>

    <p><strong>Order Number:</strong> {{ order.id }}</p>
    
<p>Your order has been received! You will receive an email confirmation shortly.</p>

 <ul>
      {% for item in order.items.all %}
        <li>
          <strong>{{ item.product.title }}</strong> - 
          {{ item.quantity }} x Â£{{ item.product.price }}
        </li>
      {% endfor %}
    </ul>
<a href="{% url 'shop:shop_index' %}">Continue Shopping</a>

  </div>
{% endblock %}



==================================================


### shop/templates/shop/cart.html ###

{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">

    <h1 class="fw-bold mb-4">Your Cart</h1>

    {% if items %}
    <table class="table align-middle">
        <thead class="table-light">
            <tr>
                <th>Product</th>
                <th style="width:120px">Quantity</th>
                <th>Total</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.product.title }}</td>

                <td>
                    <form method="POST" action="{% url 'shop:update_cart_item' item.id %}">
                        {% csrf_token %}
                        <input type="number" name="quantity" value="{{ item.quantity }}" min="1"
                               class="form-control form-control-sm"
                               onchange="this.form.submit()">
                    </form>
                </td>

                <td>Â£{{ item.total_price }}</td>

                <td>
                    <a href="{% url 'shop:remove_from_cart' item.id %}"
                       class="btn btn-outline-danger btn-sm">
                        Remove
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3 class="mt-4">Total: Â£{{ total }}</h3>

  <form action="{% url 'shop:create_checkout_session' %}" method="POST">
    {% csrf_token %}
    <button type="submit" class="btn btn-dark btn-lg mt-4">
        Checkout with Stripe
    </button>
</form>


    {% else %}
        <p class="text-muted">Your cart is empty.</p>
    {% endif %}

</div>
{% endblock %}

==================================================


### shop/templates/shop/product_list.html ###

{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        {% for product in products %}
            <div class="col-md-4 mb-4">
                <div class="card">
                   {% if product.images.first %}
    <img src="{{ product.images.first.image.url }}" class="card-img-top" alt="{{ product.title }}">
{% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ product.title }}</h5>
                        <p class="card-text">Â£{{ product.price }}</p>
                        <a href="{% url 'shop:product_detail' product.slug %}" class="btn btn-primary">View Details</a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
==================================================


### shop/templates/shop/manage/variant_form.html ###

{% extends 'dashboard_base.html' %}

{% block content %}
<h1 class="mb-4">
    {% if variant %}
        Edit Variant â€“ {{ variant.name }}
    {% else %}
        Add Variant to {{ product.title }}
    {% endif %}
</h1>

<form method="POST">
    {% csrf_token %}
    {{ form.as_p }}

    <button class="btn btn-success" type="submit">Save</button>
    <a href="{% url 'shop:edit_product' product.id %}" class="btn btn-secondary">Cancel</a>
</form>
{% endblock %}

==================================================


### shop/templates/shop/manage/orders_list.html ###

{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Orders</h1>

    {% if orders %}
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for order in orders %}
                <tr>
                    <td>#{{ order.id }}</td>
                    <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if order.user %}
                            {{ order.user.username }}
                        {% else %}
                            {{ order.email }}
                        {% endif %}
                    </td>
                    <td>Â£{{ order.total_price }}</td>
                    <td>
                        <span class="badge bg-secondary text-uppercase">
                            {{ order.get_status_display }}
                        </span>
                    </td>
                    <td class="text-end">
                        <a href="{% url 'shop:order_detail' order.id %}" class="btn btn-sm btn-dark">
                            View
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-muted">No orders yet.</p>
    {% endif %}
</div>
{% endblock %}

==================================================


### shop/templates/shop/manage/product_form.html ###

{% extends 'dashboard_base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
        {% if product %}
            Edit Product â€“ {{ product.title }}
        {% else %}
            Add Product
        {% endif %}
    </h1>
</div>

<!-- ===================================== -->
<!-- PRODUCT DETAILS FORM -->
<!-- ===================================== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Product Details</div>
    <div class="card-body">

        <form method="POST" id="productForm">
            {% csrf_token %}
            {{ form|crispy }}

            <!-- Save buttons -->
            <button type="submit" name="save_product" value="stay" class="btn btn-success mt-3">
                Save Product
            </button>

            {% if product %}
            <button type="submit" name="save_product" value="exit" class="btn btn-secondary mt-3 ms-2">
                Save & Return to Products
            </button>
            {% endif %}
        </form>

    </div>
</div>

{% if product %}

<!-- ===================================== -->
<!-- IMAGE UPLOAD -->
<!-- ===================================== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Upload Images</div>
    <div class="card-body">

        <form method="POST" enctype="multipart/form-data"
              action="{% url 'shop:upload_product_image' product.id %}">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label fw-semibold">Upload Images</label>
                <input type="file" name="images" multiple class="form-control">
            </div>

            <button type="submit" class="btn btn-primary">
                Upload Images
            </button>
        </form>

    </div>
</div>

<!-- ===================================== -->
<!-- EXISTING IMAGES (SORTABLE) -->
<!-- ===================================== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Existing Images</div>
    <div class="card-body">

        {% if images %}
        <div id="image-sort-container" class="row g-3">
            {% for image in images %}
            <div class="col-6 col-md-4 col-lg-3 image-sort-item" data-id="{{ image.id }}">
                <div class="card h-100 shadow-sm">
                    <img src="{{ image.image.url }}"
                         class="card-img-top"
                         style="object-fit: cover; height: 180px;">

                    <div class="card-body text-center">
                        <a href="{% url 'shop:delete_product_image' image.id %}"
                           class="btn btn-danger btn-sm">
                            Delete
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <p class="text-muted">No images yet.</p>
        {% endif %}

    </div>
</div>

<!-- ===================================== -->
<!-- VARIANTS -->
<!-- ===================================== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Variants</div>
    <div class="card-body">

        <a href="{% url 'shop:add_variant' product.id %}" class="btn btn-primary mb-3">
            Add Variant
        </a>

        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Stock</th>
                    <th>Price Adjust</th>
                    <th style="width: 180px;">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for variant in variants %}
                <tr>
                    <td>{{ variant.name }}</td>
                    <td>{{ variant.stock }}</td>
                    <td>Â£{{ variant.price_adjust }}</td>
                    <td>
                        <a href="{% url 'shop:edit_variant' variant.id %}"
                           class="btn btn-warning btn-sm">Edit</a>
                        <a href="{% url 'shop:delete_variant' variant.id %}"
                           class="btn btn-danger btn-sm">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-muted text-center">No variants yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
</div>

<!-- Bottom Save + Back Buttons -->
<div class="text-end mt-4">
    <a href="{% url 'shop:manage_products' %}" class="btn btn-secondary">
        Back to Products
    </a>

    <button type="submit" form="productForm" name="save_product" value="stay" class="btn btn-success ms-2">
        Save Product
    </button>
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    window.updateImageOrderUrl = "{% url 'shop:update_image_order' %}";
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{% static 'js/imageorder.js' %}"></script>
{% endblock %}

==================================================


### shop/templates/shop/manage/order_detail.html ###

{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-3">Order #{{ order.id }}</h1>

    <div class="row mb-4">
        <div class="col-md-6">
            <h5>Customer</h5>
            <p class="mb-1">
                {% if order.user %}
                    {{ order.user.username }}<br>
                    {{ order.user.email }}
                {% else %}
                    {{ order.email }}
                {% endif %}
            </p>

            <h5 class="mt-4">Shipping</h5>
            <p class="mb-1">
                {{ order.shipping_name }}<br>
                {{ order.shipping_address1 }}<br>
                {% if order.shipping_address2 %}{{ order.shipping_address2 }}<br>{% endif %}
                {{ order.shipping_city }} {{ order.shipping_postcode }}<br>
                {{ order.shipping_country }}
            </p>
        </div>

        <div class="col-md-6">
            <h5>Order Info</h5>
            <p class="mb-1">
                Placed: {{ order.created_at|date:"Y-m-d H:i" }}<br>
                Total: <strong>Â£{{ order.total_price }}</strong><br>
                Stripe Session: {{ order.stripe_session_id }}<br>
                Payment Intent: {{ order.stripe_payment_intent }}
            </p>

            <h5 class="mt-4">Status</h5>
            <form method="POST" class="d-flex gap-2 align-items-center">
                {% csrf_token %}
                <select name="status" class="form-select w-auto">
                    {% for value, label in order.STATUS_CHOICES %}
                        <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-dark btn-sm">Update</button>
            </form>
        </div>
    </div>

    <h4 class="mb-3">Items</h4>
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Product</th>
                <th style="width: 120px;">Quantity</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order.items.all %}
                <tr>
                    <td>{{ item.product.title }}</td>
                    <td>{{ item.quantity }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="{% url 'shop:manage_orders' %}" class="btn btn-outline-secondary mt-3">
        â† Back to Orders
    </a>
</div>
{% endblock %}

==================================================


### shop/templates/shop/manage/categories_list.html ###

{% extends 'dashboard_base.html' %}

{% block content %}
<h1 class="mb-4">Manage Categories</h1>

<a href="{% url 'shop:add_category' %}" class="btn btn-primary mb-3">Add Category</a>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Name</th>
            <th>Slug</th>
            <th>Description</th>
            <th style="width: 150px;">Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for category in categories %}
        <tr>
            <td>{{ category.name }}</td>
            <td>{{ category.slug }}</td>
            <td>{{ category.description|default:"â€”" }}</td>
            <td>
                <a href="{% url 'shop:edit_category' category.pk %}" class="btn btn-sm btn-warning">Edit</a>
                <a href="{% url 'shop:delete_category' category.pk %}" class="btn btn-sm btn-danger">Delete</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

==================================================


### shop/templates/shop/manage/products_list.html ###

{% extends 'dashboard_base.html' %}
{% load static %}

{% block content %}

<h1 class="mb-4">Products</h1>

<div class="d-flex justify-content-between mb-3">

    <a href="{% url 'shop:add_product' %}" class="btn btn-primary">
        Add Product
    </a>

    <!-- CATEGORY FILTER -->
    <form method="get" class="d-flex align-items-center">
        <select name="category" class="form-select me-2" style="width: 200px;">
            <option value="">All Categories</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}"
                    {% if request.GET.category == cat.id|stringformat:'s' %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>
        <button class="btn btn-outline-secondary">Filter</button>
    </form>

</div>

<!-- BULK DELETE FORM -->
<form id="bulkDeleteForm" method="POST" action="{% url 'shop:bulk_delete' %}">
    {% csrf_token %}

    <button type="submit"
        class="btn btn-danger mb-3"
        onclick="return confirmBulkDelete();">
        Delete Selected
    </button>

    <div class="row g-4">

        {% for product in products %}
        <div class="col-12 col-md-6 col-lg-4 col-xl-3">

            <div class="card h-100 shadow-sm position-relative">

                <!-- SELECT FOR BULK DELETE -->
                <div class="position-absolute p-2" style="z-index: 10;">
                    <input type="checkbox"
                           name="selected_products[]"
                           value="{{ product.id }}"
                           class="product-checkbox">
                </div>

                <!-- FEATURED IMAGE -->
                {% if product.featured %}
                <img src="{{ product.featured.image.url }}"
                     class="card-img-top"
                     style="height: 200px; object-fit: cover;">
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center"
                     style="height: 200px;">
                    <span class="text-muted">No Image</span>
                </div>
                {% endif %}

                <div class="card-body">
                    <h5 class="card-title">{{ product.title }}</h5>

                    <!-- PRICE -->
                    <p class="mb-1 text-muted">Â£{{ product.price }}</p>

                    <!-- CATEGORY -->
                    <p class="small text-muted">{{ product.category.name }}</p>

                    <!-- STOCK TOTAL -->
                    <p class="small">
                        <strong>Stock:</strong> {{ product.stock }}
                    </p>
                </div>

                <div class="card-footer bg-white text-end">

                    <a href="{% url 'shop:edit_product' product.id %}"
                       class="btn btn-warning btn-sm">Edit</a>

                    <a href="{% url 'shop:delete_product' product.id %}"
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Delete product?');">
                        Delete
                    </a>

                    <a href="{% url 'shop:duplicate_product' product.id %}"
                       class="btn btn-secondary btn-sm">
                        Duplicate
                    </a>

                </div>

            </div>

        </div>
        {% empty %}
        <p>No products yet.</p>
        {% endfor %}

    </div>

</form>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/bulkdelete.js' %}"></script>
{% endblock %}

==================================================


### shop/templates/shop/manage/category_form.html ###

{% extends 'dashboard_base.html' %}

{% block content %}

<h1 class="mb-4">
    {% if form.instance.pk %}
        Edit Category
    {% else %}
        Add Category
    {% endif %}
</h1>

<form method="POST">
    {% csrf_token %}

    <div class="mb-3">
        {{ form.name.label_tag }}
        {{ form.name }}
    </div>

    <div class="mb-3">
        {{ form.description.label_tag }}
        {{ form.description }}
    </div>

    <button type="submit" class="btn btn-success">Save</button>
    <a href="{% url 'shop:manage_categories' %}" class="btn btn-secondary">Cancel</a>
</form>

{% endblock %}

==================================================


### shop/templates/shop/cancel.html ###

<!-- shop/templates/shop/cancel.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Canceled</title>
</head>
<body>
    <h1>Payment Canceled</h1>
    <p>Your payment has been canceled. If you have any issues, please contact support.</p>
    <a href="/shop/">Back to Shop</a>
</body>
</html>

==================================================


### shop/templates/shop/product_detail.html ###

{% extends "base.html" %}
{% load static %}

{% block content %}


<div class="product-container">

    <div class="row g-5">

        <!-- LEFT SIDE â€” ARTWORK IMAGES -->
        <div class="col-md-7">

            <div class="image-wrapper">
                {% if images %}
                    <img id="main-img"
                         src="{{ images.0.image.url }}"
                         class="main-image shadow-sm">
                {% else %}
                    <img src="{% static 'img/placeholder.png' %}"
                         class="main-image shadow-sm">
                {% endif %}
            </div>

            {% if images|length > 1 %}
                <div class="thumbnail-row">
                    {% for img in images %}
                        <img src="{{ img.image.url }}"
                             onclick="document.getElementById('main-img').src='{{ img.image.url }}'">
                    {% endfor %}
                </div>
            {% endif %}
        </div>


        <!-- RIGHT SIDE â€” BUY BOX -->
        <div class="col-md-5">

            <div class="buy-box shadow-sm">

                <h1 class="product-title">{{ product.title }}</h1>

                 <p class="product-description">{{ product.description|linebreaks }}</p>

                {% if variants %}
                    <label class="fw-semibold">Select Option</label>
                    <select class="form-select variant-select" id="variantSelect">
                        {% for v in variants %}
                            <option value="{{ v.id }}">{{ v.name }} â€” Â£{{ v.final_price }}</option>
                        {% endfor %}
                    </select>
                {% endif %}

                   {% if variants %}
                        <input type="hidden" name="variant_id" id="variantInput">
                    {% endif %}

                <div class="product-price">Â£{{ product.price }}</div>

                <form method="POST" action="{% url 'shop:add_to_cart' product.id %}">
                    {% csrf_token %}

                    <button class="btn btn-dark buy-btn">
                        Add to Cart
                    </button>
                </form>

               

            </div>

        </div>

    </div>

</div>


<script>
    // Keep variant dropdown synced to hidden input
    const select = document.getElementById("variantSelect");
    const hiddenInput = document.getElementById("variantInput");

    if (select && hiddenInput) {
        hiddenInput.value = select.value;
        select.addEventListener("change", () => {
            hiddenInput.value = select.value;
        });
    }
</script>

{% endblock %}

==================================================


### shop/templates/shop/success.html ###

{% extends 'base.html' %}

{% block content %}
  <div class="thank-you">
    <h1>Thank you for your order!</h1>
    
    <h2>Payment Successful</h2>

    <p><strong>Order Number:</strong> {{ order.id }}</p>
    
<p>Your order has been received! You will receive an email confirmation shortly.</p>

 <ul>
      {% for item in order.items.all %}
        <li>
          <strong>{{ item.product.title }}</strong> - 
          {{ item.quantity }} x Â£{{ item.product.price }}
        </li>
      {% endfor %}
    </ul>
<a href="{% url 'shop:shop_index' %}">Continue Shopping</a>

  </div>
{% endblock %}



==================================================


### shop/templates/shop/cart.html ###

{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">

    <h1 class="fw-bold mb-4">Your Cart</h1>

    {% if items %}
    <table class="table align-middle">
        <thead class="table-light">
            <tr>
                <th>Product</th>
                <th style="width:120px">Quantity</th>
                <th>Total</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.product.title }}</td>

                <td>
                    <form method="POST" action="{% url 'shop:update_cart_item' item.id %}">
                        {% csrf_token %}
                        <input type="number" name="quantity" value="{{ item.quantity }}" min="1"
                               class="form-control form-control-sm"
                               onchange="this.form.submit()">
                    </form>
                </td>

                <td>Â£{{ item.total_price }}</td>

                <td>
                    <a href="{% url 'shop:remove_from_cart' item.id %}"
                       class="btn btn-outline-danger btn-sm">
                        Remove
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3 class="mt-4">Total: Â£{{ total }}</h3>

  <form action="{% url 'shop:create_checkout_session' %}" method="POST">
    {% csrf_token %}
    <button type="submit" class="btn btn-dark btn-lg mt-4">
        Checkout with Stripe
    </button>
</form>


    {% else %}
        <p class="text-muted">Your cart is empty.</p>
    {% endif %}

</div>
{% endblock %}

==================================================


### shop/templates/shop/product_list.html ###

{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        {% for product in products %}
            <div class="col-md-4 mb-4">
                <div class="card">
                   {% if product.images.first %}
    <img src="{{ product.images.first.image.url }}" class="card-img-top" alt="{{ product.title }}">
{% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ product.title }}</h5>
                        <p class="card-text">Â£{{ product.price }}</p>
                        <a href="{% url 'shop:product_detail' product.slug %}" class="btn btn-primary">View Details</a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
==================================================


### shop/templates/shop/manage/variant_form.html ###

{% extends 'dashboard_base.html' %}

{% block content %}
<h1 class="mb-4">
    {% if variant %}
        Edit Variant â€“ {{ variant.name }}
    {% else %}
        Add Variant to {{ product.title }}
    {% endif %}
</h1>

<form method="POST">
    {% csrf_token %}
    {{ form.as_p }}

    <button class="btn btn-success" type="submit">Save</button>
    <a href="{% url 'shop:edit_product' product.id %}" class="btn btn-secondary">Cancel</a>
</form>
{% endblock %}

==================================================


### shop/templates/shop/manage/orders_list.html ###

{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Orders</h1>

    {% if orders %}
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for order in orders %}
                <tr>
                    <td>#{{ order.id }}</td>
                    <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if order.user %}
                            {{ order.user.username }}
                        {% else %}
                            {{ order.email }}
                        {% endif %}
                    </td>
                    <td>Â£{{ order.total_price }}</td>
                    <td>
                        <span class="badge bg-secondary text-uppercase">
                            {{ order.get_status_display }}
                        </span>
                    </td>
                    <td class="text-end">
                        <a href="{% url 'shop:order_detail' order.id %}" class="btn btn-sm btn-dark">
                            View
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-muted">No orders yet.</p>
    {% endif %}
</div>
{% endblock %}

==================================================


### shop/templates/shop/manage/product_form.html ###

{% extends 'dashboard_base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
        {% if product %}
            Edit Product â€“ {{ product.title }}
        {% else %}
            Add Product
        {% endif %}
    </h1>
</div>

<!-- ===================================== -->
<!-- PRODUCT DETAILS FORM -->
<!-- ===================================== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Product Details</div>
    <div class="card-body">

        <form method="POST" id="productForm">
            {% csrf_token %}
            {{ form|crispy }}

            <!-- Save buttons -->
            <button type="submit" name="save_product" value="stay" class="btn btn-success mt-3">
                Save Product
            </button>

            {% if product %}
            <button type="submit" name="save_product" value="exit" class="btn btn-secondary mt-3 ms-2">
                Save & Return to Products
            </button>
            {% endif %}
        </form>

    </div>
</div>

{% if product %}

<!-- ===================================== -->
<!-- IMAGE UPLOAD -->
<!-- ===================================== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Upload Images</div>
    <div class="card-body">

        <form method="POST" enctype="multipart/form-data"
              action="{% url 'shop:upload_product_image' product.id %}">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label fw-semibold">Upload Images</label>
                <input type="file" name="images" multiple class="form-control">
            </div>

            <button type="submit" class="btn btn-primary">
                Upload Images
            </button>
        </form>

    </div>
</div>

<!-- ===================================== -->
<!-- EXISTING IMAGES (SORTABLE) -->
<!-- ===================================== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Existing Images</div>
    <div class="card-body">

        {% if images %}
        <div id="image-sort-container" class="row g-3">
            {% for image in images %}
            <div class="col-6 col-md-4 col-lg-3 image-sort-item" data-id="{{ image.id }}">
                <div class="card h-100 shadow-sm">
                    <img src="{{ image.image.url }}"
                         class="card-img-top"
                         style="object-fit: cover; height: 180px;">

                    <div class="card-body text-center">
                        <a href="{% url 'shop:delete_product_image' image.id %}"
                           class="btn btn-danger btn-sm">
                            Delete
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <p class="text-muted">No images yet.</p>
        {% endif %}

    </div>
</div>

<!-- ===================================== -->
<!-- VARIANTS -->
<!-- ===================================== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Variants</div>
    <div class="card-body">

        <a href="{% url 'shop:add_variant' product.id %}" class="btn btn-primary mb-3">
            Add Variant
        </a>

        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Stock</th>
                    <th>Price Adjust</th>
                    <th style="width: 180px;">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for variant in variants %}
                <tr>
                    <td>{{ variant.name }}</td>
                    <td>{{ variant.stock }}</td>
                    <td>Â£{{ variant.price_adjust }}</td>
                    <td>
                        <a href="{% url 'shop:edit_variant' variant.id %}"
                           class="btn btn-warning btn-sm">Edit</a>
                        <a href="{% url 'shop:delete_variant' variant.id %}"
                           class="btn btn-danger btn-sm">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-muted text-center">No variants yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
</div>

<!-- Bottom Save + Back Buttons -->
<div class="text-end mt-4">
    <a href="{% url 'shop:manage_products' %}" class="btn btn-secondary">
        Back to Products
    </a>

    <button type="submit" form="productForm" name="save_product" value="stay" class="btn btn-success ms-2">
        Save Product
    </button>
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    window.updateImageOrderUrl = "{% url 'shop:update_image_order' %}";
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{% static 'js/imageorder.js' %}"></script>
{% endblock %}

==================================================


### shop/templates/shop/manage/order_detail.html ###

{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-3">Order #{{ order.id }}</h1>

    <div class="row mb-4">
        <div class="col-md-6">
            <h5>Customer</h5>
            <p class="mb-1">
                {% if order.user %}
                    {{ order.user.username }}<br>
                    {{ order.user.email }}
                {% else %}
                    {{ order.email }}
                {% endif %}
            </p>

            <h5 class="mt-4">Shipping</h5>
            <p class="mb-1">
                {{ order.shipping_name }}<br>
                {{ order.shipping_address1 }}<br>
                {% if order.shipping_address2 %}{{ order.shipping_address2 }}<br>{% endif %}
                {{ order.shipping_city }} {{ order.shipping_postcode }}<br>
                {{ order.shipping_country }}
            </p>
        </div>

        <div class="col-md-6">
            <h5>Order Info</h5>
            <p class="mb-1">
                Placed: {{ order.created_at|date:"Y-m-d H:i" }}<br>
                Total: <strong>Â£{{ order.total_price }}</strong><br>
                Stripe Session: {{ order.stripe_session_id }}<br>
                Payment Intent: {{ order.stripe_payment_intent }}
            </p>

            <h5 class="mt-4">Status</h5>
            <form method="POST" class="d-flex gap-2 align-items-center">
                {% csrf_token %}
                <select name="status" class="form-select w-auto">
                    {% for value, label in order.STATUS_CHOICES %}
                        <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-dark btn-sm">Update</button>
            </form>
        </div>
    </div>

    <h4 class="mb-3">Items</h4>
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Product</th>
                <th style="width: 120px;">Quantity</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order.items.all %}
                <tr>
                    <td>{{ item.product.title }}</td>
                    <td>{{ item.quantity }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="{% url 'shop:manage_orders' %}" class="btn btn-outline-secondary mt-3">
        â† Back to Orders
    </a>
</div>
{% endblock %}

==================================================


### shop/templates/shop/manage/categories_list.html ###

{% extends 'dashboard_base.html' %}

{% block content %}
<h1 class="mb-4">Manage Categories</h1>

<a href="{% url 'shop:add_category' %}" class="btn btn-primary mb-3">Add Category</a>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Name</th>
            <th>Slug</th>
            <th>Description</th>
            <th style="width: 150px;">Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for category in categories %}
        <tr>
            <td>{{ category.name }}</td>
            <td>{{ category.slug }}</td>
            <td>{{ category.description|default:"â€”" }}</td>
            <td>
                <a href="{% url 'shop:edit_category' category.pk %}" class="btn btn-sm btn-warning">Edit</a>
                <a href="{% url 'shop:delete_category' category.pk %}" class="btn btn-sm btn-danger">Delete</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

==================================================


### shop/templates/shop/manage/products_list.html ###

{% extends 'dashboard_base.html' %}
{% load static %}

{% block content %}

<h1 class="mb-4">Products</h1>

<div class="d-flex justify-content-between mb-3">

    <a href="{% url 'shop:add_product' %}" class="btn btn-primary">
        Add Product
    </a>

    <!-- CATEGORY FILTER -->
    <form method="get" class="d-flex align-items-center">
        <select name="category" class="form-select me-2" style="width: 200px;">
            <option value="">All Categories</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}"
                    {% if request.GET.category == cat.id|stringformat:'s' %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>
        <button class="btn btn-outline-secondary">Filter</button>
    </form>

</div>

<!-- BULK DELETE FORM -->
<form id="bulkDeleteForm" method="POST" action="{% url 'shop:bulk_delete' %}">
    {% csrf_token %}

    <button type="submit"
        class="btn btn-danger mb-3"
        onclick="return confirmBulkDelete();">
        Delete Selected
    </button>

    <div class="row g-4">

        {% for product in products %}
        <div class="col-12 col-md-6 col-lg-4 col-xl-3">

            <div class="card h-100 shadow-sm position-relative">

                <!-- SELECT FOR BULK DELETE -->
                <div class="position-absolute p-2" style="z-index: 10;">
                    <input type="checkbox"
                           name="selected_products[]"
                           value="{{ product.id }}"
                           class="product-checkbox">
                </div>

                <!-- FEATURED IMAGE -->
                {% if product.featured %}
                <img src="{{ product.featured.image.url }}"
                     class="card-img-top"
                     style="height: 200px; object-fit: cover;">
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center"
                     style="height: 200px;">
                    <span class="text-muted">No Image</span>
                </div>
                {% endif %}

                <div class="card-body">
                    <h5 class="card-title">{{ product.title }}</h5>

                    <!-- PRICE -->
                    <p class="mb-1 text-muted">Â£{{ product.price }}</p>

                    <!-- CATEGORY -->
                    <p class="small text-muted">{{ product.category.name }}</p>

                    <!-- STOCK TOTAL -->
                    <p class="small">
                        <strong>Stock:</strong> {{ product.stock }}
                    </p>
                </div>

                <div class="card-footer bg-white text-end">

                    <a href="{% url 'shop:edit_product' product.id %}"
                       class="btn btn-warning btn-sm">Edit</a>

                    <a href="{% url 'shop:delete_product' product.id %}"
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Delete product?');">
                        Delete
                    </a>

                    <a href="{% url 'shop:duplicate_product' product.id %}"
                       class="btn btn-secondary btn-sm">
                        Duplicate
                    </a>

                </div>

            </div>

        </div>
        {% empty %}
        <p>No products yet.</p>
        {% endfor %}

    </div>

</form>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/bulkdelete.js' %}"></script>
{% endblock %}

==================================================


### shop/templates/shop/manage/category_form.html ###

{% extends 'dashboard_base.html' %}

{% block content %}

<h1 class="mb-4">
    {% if form.instance.pk %}
        Edit Category
    {% else %}
        Add Category
    {% endif %}
</h1>

<form method="POST">
    {% csrf_token %}

    <div class="mb-3">
        {{ form.name.label_tag }}
        {{ form.name }}
    </div>

    <div class="mb-3">
        {{ form.description.label_tag }}
        {{ form.description }}
    </div>

    <button type="submit" class="btn btn-success">Save</button>
    <a href="{% url 'shop:manage_categories' %}" class="btn btn-secondary">Cancel</a>
</form>

{% endblock %}

==================================================


### shop/forms.py ###

from django import forms
from .models import Product, ProductImage, Category, ProductVariant

# ============================
# PRODUCT FORM
# ============================
class ProductForm(forms.ModelForm):
    class Meta:
        model = Product
        fields = [
            'title',
            'category',
            'description',
            'price',
            'stock',
            'featured'
        ]


# ============================
# SINGLE IMAGE FORM
# ============================
class ProductImageForm(forms.ModelForm):
    class Meta:
        model = ProductImage
        fields = ['image']


# ============================
# MULTI-IMAGE UPLOADER
# ============================
class MultipleFileInput(forms.ClearableFileInput):
    allow_multiple_selected = True


class MultiImageUploadForm(forms.Form):
    images = forms.FileField(
        widget=MultipleFileInput(attrs={'multiple': True}),
        required=False
    )

    def clean_images(self):
        # ALWAYS return a list of uploaded files.
        # This bypasses Django's single-file validation.
        return self.files.getlist('images')


# ============================
# CATEGORY FORM
# ============================
class CategoryForm(forms.ModelForm):
    class Meta:
        model = Category
        fields = ['name', 'description']


# ============================
# VARIANT FORM
# ============================
class VariantForm(forms.ModelForm):
    class Meta:
        model = ProductVariant
        fields = ['name', 'stock', 'price_adjust']


# ============================
# CHECKOUT FORM
# ============================
class CheckoutForm(forms.Form):
    name = forms.CharField(max_length=100)
    address = forms.CharField(widget=forms.Textarea)
    payment_method = forms.ChoiceField(choices=[('card', 'Credit Card'), ('paypal', 'PayPal')])

    def clean(self):
        # You can add any custom validation logic for the checkout form here
        cleaned_data = super().clean()
        # Example of custom validation:
        # if not cleaned_data.get("payment_method"):
        #     raise forms.ValidationError("Please select a payment method.")
        return cleaned_data

==================================================


### shop/urls.py ###

from django.urls import path
from . import views

app_name = "shop"

urlpatterns = [

    # ============================
    # MANAGEMENT PANEL (ADMIN SIDE)
    # ============================
    path('manage/products/', views.manage_products, name='manage_products'),
    path('manage/products/add/', views.add_product, name='add_product'),
    path('manage/products/<int:pk>/edit/', views.edit_product, name='edit_product'),
    path('manage/products/<int:pk>/delete/', views.delete_product, name='delete_product'),
    path('manage/products/bulk-delete/', views.bulk_delete, name='bulk_delete'),
    path('manage/products/<int:pk>/duplicate/', views.duplicate_product, name='duplicate_product'),
        # Orders (admin)
    path('manage/orders/', views.manage_orders, name='manage_orders'),
    path('manage/orders/<int:order_id>/', views.order_detail, name='order_detail'),



    # Image uploads + ordering
    path('manage/products/<int:product_id>/images/upload/', views.upload_product_image, name='upload_product_image'),
    path('manage/images/<int:image_id>/delete/', views.delete_product_image, name='delete_product_image'),
    path('manage/images/reorder/', views.update_image_order, name='update_image_order'),

    # Categories
    path('manage/categories/', views.manage_categories, name='manage_categories'),
    path('manage/categories/add/', views.add_category, name='add_category'),
    path('manage/categories/<int:pk>/edit/', views.edit_category, name='edit_category'),
    path('manage/categories/<int:pk>/delete/', views.delete_category, name='delete_category'),

    # Variants
    path('manage/variants/add/<int:product_id>/', views.add_variant, name='add_variant'),
    path('manage/variants/<int:variant_id>/edit/', views.edit_variant, name='edit_variant'),
    path('manage/variants/<int:variant_id>/delete/', views.delete_variant, name='delete_variant'),


# ============================
# PUBLIC SHOP FRONT
# ============================

path('webhooks/stripe/', views.stripe_webhook, name='stripe_webhook'),


# Shop index / product list
path('', views.product_list, name='shop_index'),

# Add to cart
path('add-to-cart/<int:product_id>/', views.add_to_cart, name='add_to_cart'),

# Cart + Checkout
path('cart/', views.cart_view, name='cart'),
path('remove-from-cart/<int:item_id>/', views.remove_from_cart, name='remove_from_cart'),
path('update-cart-item/<int:item_id>/', views.update_cart_item, name='update_cart_item'),
path('create-checkout-session/', views.create_checkout_session, name='create_checkout_session'),
path('thank-you/', views.success, name='success'),
path('cancel/', views.cancel, name='cancel'),
path("webhook/stripe/", views.stripe_webhook, name="stripe_webhook"),


# Product detail (slug LAST so it doesnâ€™t swallow other routes)
path('<slug:slug>/', views.product_detail, name='product_detail'),

]
==================================================
